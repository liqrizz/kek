//import L from 'leaflet';
import turf from './myTurf.js';
import './PaintPolygon.css';

"use strict";

const zoneData = `{
    "type": "MultiPolygon",
    "coordinates": [
        [
            [
                [
                    76.90976699189065,
                    43.232195008677834
                ],
                [
                    76.90986679035794,
                    43.230722303643475
                ],
                [
                    76.91016421849467,
                    43.229263816635665
                ],
                [
                    76.91065639817687,
                    43.227833592160756
                ],
                [
                    76.91133857679637,
                    43.226445401595136
                ],
                [
                    76.9122041735166,
                    43.22511261065429
                ],
                [
                    76.91324484307515,
                    43.22384805080132
                ],
                [
                    76.91445055650202,
                    43.22266389582826
                ],
                [
                    76.91580969796314,
                    43.22157154479299
                ],
                [
                    76.91730917678619,
                    43.220581512432275
                ],
                [
                    76.91893455358426,
                    43.21970332809882
                ],
                [
                    76.92067017926037,
                    43.21894544418812
                ],
                [
                    76.92249934555625,
                    43.218315154929286
                ],
                [
                    76.9228784712746,
                    43.21821632302233
                ],
                [
                    76.92301420799386,
                    43.21794006874162
                ],
                [
                    76.92387968384628,
                    43.21660727775903
                ],
                [
                    76.92492020813384,
                    43.21534271785844
                ],
                [
                    76.92612575328855,
                    43.21415856283371
                ],
                [
                    76.92748470509865,
                    43.21306621174471
                ],
                [
                    76.9278449488553,
                    43.212828327249916
                ],
                [
                    76.92817147020544,
                    43.212565861076804
                ],
                [
                    76.92853171396133,
                    43.21232797462948
                ],
                [
                    76.92885823531014,
                    43.21206550630238
                ],
                [
                    76.92921847906494,
                    43.21182761790275
                ],
                [
                    76.92954500041273,
                    43.21156514742141
                ],
                [
                    76.93104423312131,
                    43.210575114997496
                ],
                [
                    76.93176907754822,
                    43.21018342025453
                ],
                [
                    76.93230673955492,
                    43.20965525901583
                ],
                [
                    76.93366559098439,
                    43.2085629078984
                ],
                [
                    76.93402583473278,
                    43.20832500583185
                ],
                [
                    76.93435235607234,
                    43.20806252027179
                ],
                [
                    76.9347125998193,
                    43.20782461625318
                ],
                [
                    76.9350391211582,
                    43.207562128538605
                ],
                [
                    76.93539936490463,
                    43.207324222567344
                ],
                [
                    76.93572588624197,
                    43.207061732698975
                ],
                [
                    76.93608612998709,
                    43.20682382477557
                ],
                [
                    76.93641265132364,
                    43.2065613327528
                ],
                [
                    76.93677289506813,
                    43.206323422876814
                ],
                [
                    76.93709941640323,
                    43.20606092870017
                ],
                [
                    76.93859851378558,
                    43.20507089624149
                ],
                [
                    76.94022347716644,
                    43.20419271181385
                ],
                [
                    76.94075068904483,
                    43.203962439182284
                ],
                [
                    76.94134541761696,
                    43.20356965943516
                ],
                [
                    76.94297034100158,
                    43.202691474998396
                ],
                [
                    76.94405609488533,
                    43.202217233862164
                ],
                [
                    76.94503046538608,
                    43.20169062992242
                ],
                [
                    76.94676557847289,
                    43.20093274591093
                ],
                [
                    76.9485942045969,
                    43.20030245656375
                ],
                [
                    76.95049874218205,
                    43.19980582787639
                ],
                [
                    76.95096848622607,
                    43.19972007518613
                ],
                [
                    76.952558727778,
                    43.199305399171436
                ],
                [
                    76.95452083007045,
                    43.19894721063657
                ],
                [
                    76.95492915181269,
                    43.198903068014936
                ],
                [
                    76.95530535888093,
                    43.19880496636
                ],
                [
                    76.95726744508049,
                    43.198446777823655
                ],
                [
                    76.95896429018597,
                    43.19826333472384
                ],
                [
                    76.96070070559773,
                    43.197946340904274
                ],
                [
                    76.96270147191814,
                    43.197730039612914
                ],
                [
                    76.96425563365469,
                    43.197674393681915
                ],
                [
                    76.96550725713004,
                    43.197445899878424
                ],
                [
                    76.96750800704123,
                    43.19722959858614
                ],
                [
                    76.96952819824222,
                    43.19715726612552
                ],
                [
                    76.96978905984943,
                    43.1971666062127
                ],
                [
                    76.9710004541696,
                    43.19694545474618
                ],
                [
                    76.97300118767187,
                    43.19672915345297
                ],
                [
                    76.9750213623047,
                    43.19665682099204
                ],
                [
                    76.97570800781251,
                    43.196681406371226
                ],
                [
                    76.97639465332033,
                    43.19665682099204
                ],
                [
                    76.97708129882814,
                    43.196681406371226
                ],
                [
                    76.97776794433594,
                    43.19665682099204
                ],
                [
                    76.97845458984375,
                    43.196681406371226
                ],
                [
                    76.97914123535156,
                    43.19665682099204
                ],
                [
                    76.97940211368774,
                    43.19666616175484
                ],
                [
                    76.98061352425543,
                    43.196445005507435
                ],
                [
                    76.98231036936043,
                    43.19626155638647
                ],
                [
                    76.98404678477037,
                    43.195944552162295
                ],
                [
                    76.98604748545566,
                    43.195728250867255
                ],
                [
                    76.98806762695314,
                    43.19565591840569
                ],
                [
                    76.98909759521487,
                    43.19569279707968
                ],
                [
                    76.99012756347658,
                    43.19565591840569
                ],
                [
                    76.9911575317383,
                    43.19569279707968
                ],
                [
                    76.99218750000003,
                    43.19565591840569
                ],
                [
                    76.99287414550784,
                    43.195680504188346
                ],
                [
                    76.99356079101564,
                    43.19565591840569
                ],
                [
                    76.99459075927737,
                    43.19569279707968
                ],
                [
                    76.99562072753908,
                    43.19565591840569
                ],
                [
                    76.9969940185547,
                    43.19570508997101
                ],
                [
                    76.99836730957033,
                    43.19565591840569
                ],
                [
                    76.99939727783203,
                    43.19569279707968
                ],
                [
                    77.00042724609375,
                    43.19565591840569
                ],
                [
                    77.00145721435547,
                    43.19569279707968
                ],
                [
                    77.0024871826172,
                    43.19565591840569
                ],
                [
                    77.00317382812501,
                    43.195680504188346
                ],
                [
                    77.00386047363283,
                    43.19565591840569
                ],
                [
                    77.00454711914064,
                    43.195680504188346
                ],
                [
                    77.00523376464844,
                    43.19565591840569
                ],
                [
                    77.00592041015625,
                    43.195680504188346
                ],
                [
                    77.00605746414698,
                    43.19567559688233
                ],
                [
                    77.00749076095234,
                    43.19530182169949
                ],
                [
                    77.00945273450948,
                    43.194943633152654
                ],
                [
                    77.01145340237892,
                    43.194727331855766
                ],
                [
                    77.0134735107422,
                    43.194654999393585
                ],
                [
                    77.01381683349611,
                    43.19466729248665
                ],
                [
                    77.01416015625,
                    43.194654999393585
                ],
                [
                    77.0145034790039,
                    43.19466729248665
                ],
                [
                    77.01484680175784,
                    43.194654999393585
                ],
                [
                    77.01519012451175,
                    43.19466729248665
                ],
                [
                    77.01553344726564,
                    43.194654999393585
                ],
                [
                    77.01587677001955,
                    43.19466729248665
                ],
                [
                    77.01622009277345,
                    43.194654999393585
                ],
                [
                    77.01656341552736,
                    43.19466729248665
                ],
                [
                    77.01690673828126,
                    43.194654999393585
                ],
                [
                    77.01725006103517,
                    43.19466729248665
                ],
                [
                    77.01759338378908,
                    43.194654999393585
                ],
                [
                    77.01793670654298,
                    43.19466729248665
                ],
                [
                    77.01828002929689,
                    43.194654999393585
                ],
                [
                    77.0186233520508,
                    43.19466729248665
                ],
                [
                    77.0189666748047,
                    43.194654999393585
                ],
                [
                    77.02098678316798,
                    43.194727331855766
                ],
                [
                    77.02298745103742,
                    43.194943633152654
                ],
                [
                    77.02494942459457,
                    43.19530182169949
                ],
                [
                    77.02685382159488,
                    43.195798450404965
                ],
                [
                    77.02868231272907,
                    43.19642873977423
                ],
                [
                    77.03041729771903,
                    43.19718662381091
                ],
                [
                    77.03204207446883,
                    43.198064808281075
                ],
                [
                    77.03354099965546,
                    43.19905484078397
                ],
                [
                    77.03386752097472,
                    43.19931736511809
                ],
                [
                    77.03422776470575,
                    43.19955530232704
                ],
                [
                    77.03455428602634,
                    43.199817824507235
                ],
                [
                    77.03491452975811,
                    43.2000557597637
                ],
                [
                    77.03524105107951,
                    43.200318279789535
                ],
                [
                    77.0356012948126,
                    43.20055621309389
                ],
                [
                    77.03592781613526,
                    43.20081873096574
                ],
                [
                    77.03628805986916,
                    43.20105666231766
                ],
                [
                    77.03764674403271,
                    43.20214901348249
                ],
                [
                    77.03885205171191,
                    43.20333316858016
                ],
                [
                    77.03989237098457,
                    43.204597728547974
                ],
                [
                    77.04075767626132,
                    43.20593051958948
                ],
                [
                    77.04143962509606,
                    43.20731871023776
                ],
                [
                    77.04193163887683,
                    43.20874893477409
                ],
                [
                    77.04222896660647,
                    43.21020742181975
                ],
                [
                    77.04226224942946,
                    43.2106987365027
                ],
                [
                    77.04281437279494,
                    43.2118225683399
                ],
                [
                    77.0433064229829,
                    43.213252792862754
                ],
                [
                    77.04360377274695,
                    43.21471127990011
                ],
                [
                    77.04363831840233,
                    43.215221198213676
                ],
                [
                    77.04399406401501,
                    43.216255180130304
                ],
                [
                    77.04429142847059,
                    43.21771366716213
                ],
                [
                    77.04439120541767,
                    43.21918637220461
                ],
                [
                    77.04437442365732,
                    43.21943656196161
                ],
                [
                    77.04439137462481,
                    43.21968675570853
                ],
                [
                    77.04437459286594,
                    43.21993694341227
                ],
                [
                    77.0443915438349,
                    43.22018713510596
                ],
                [
                    77.04437476207751,
                    43.22043732075643
                ],
                [
                    77.04439171304796,
                    43.220687510396864
                ],
                [
                    77.04437493129205,
                    43.22093769399402
                ],
                [
                    77.04439188226398,
                    43.221187881581216
                ],
                [
                    77.04437510050955,
                    43.22143806312511
                ],
                [
                    77.04439205148296,
                    43.22168824865907
                ],
                [
                    77.04437526973001,
                    43.22193842814964
                ],
                [
                    77.0443922207049,
                    43.2221886116304
                ],
                [
                    77.04437543895344,
                    43.22243878906776
                ],
                [
                    77.0443923899298,
                    43.222688970495156
                ],
                [
                    77.04437560817982,
                    43.22293914587919
                ],
                [
                    77.04439255915766,
                    43.22318932525337
                ],
                [
                    77.04437577740916,
                    43.22343949858407
                ],
                [
                    77.04439272838849,
                    43.223689675905085
                ],
                [
                    77.04437594664147,
                    43.22393984718238
                ],
                [
                    77.04439289762229,
                    43.2241900224502
                ],
                [
                    77.04437611587673,
                    43.22444019167443
                ],
                [
                    77.04439306685902,
                    43.22469036488879
                ],
                [
                    77.04437628511495,
                    43.22494053205955
                ],
                [
                    77.04439323609873,
                    43.225190703220804
                ],
                [
                    77.04429444073433,
                    43.22666344383876
                ],
                [
                    77.04399800030163,
                    43.2281220362299
                ],
                [
                    77.04350675595032,
                    43.22955243183803
                ],
                [
                    77.04282542597161,
                    43.230940852710226
                ],
                [
                    77.04196056084551,
                    43.23227392428043
                ],
                [
                    77.04092048058307,
                    43.23353880430112
                ],
                [
                    77.04019811286722,
                    43.234248715920806
                ],
                [
                    77.03954761191636,
                    43.23503979468776
                ],
                [
                    77.03834229661352,
                    43.23622429707218
                ],
                [
                    77.03698337553745,
                    43.237317009403185
                ],
                [
                    77.03662324112786,
                    43.23755488125541
                ],
                [
                    77.0362968497739,
                    43.2378173313251
                ],
                [
                    77.03479739635331,
                    43.23880772498474
                ],
                [
                    77.03317186369651,
                    43.239686256732604
                ],
                [
                    77.03264524423783,
                    43.239916265860465
                ],
                [
                    77.03205113664181,
                    43.24030866612055
                ],
                [
                    77.03042556394968,
                    43.24118719787753
                ],
                [
                    77.02868956822657,
                    43.24194540197558
                ],
                [
                    77.02761003779345,
                    43.242317442122875
                ],
                [
                    77.02731635705551,
                    43.24244570748012
                ],
                [
                    77.02548664862861,
                    43.243076277388006
                ],
                [
                    77.02358087194986,
                    43.243573136325566
                ],
                [
                    77.02311114250104,
                    43.24365886781006
                ],
                [
                    77.02152098459817,
                    43.24407343772805
                ],
                [
                    77.02138151856683,
                    43.24409889180974
                ],
                [
                    77.02074390210707,
                    43.24431862728605
                ],
                [
                    77.02045022136961,
                    43.24444688843244
                ],
                [
                    77.01862045284392,
                    43.24507745835014
                ],
                [
                    77.01671461356389,
                    43.24557431729578
                ],
                [
                    77.01475106890311,
                    43.245932676926486
                ],
                [
                    77.01274874153518,
                    43.246149083576306
                ],
                [
                    77.01072692871095,
                    43.2462214516118
                ],
                [
                    77.01038360595705,
                    43.24620916284158
                ],
                [
                    77.01004028320314,
                    43.2462214516118
                ],
                [
                    77.00969696044923,
                    43.24620916284158
                ],
                [
                    77.00935363769533,
                    43.2462214516118
                ],
                [
                    77.00901031494142,
                    43.24620916284158
                ],
                [
                    77.00866699218751,
                    43.2462214516118
                ],
                [
                    77.00832366943361,
                    43.24620916284158
                ],
                [
                    77.0079803466797,
                    43.2462214516118
                ],
                [
                    77.0077211244497,
                    43.24621217310525
                ],
                [
                    77.0065113558589,
                    43.24643296190397
                ],
                [
                    77.00450901204636,
                    43.24664936855471
                ],
                [
                    77.0024871826172,
                    43.24672173659053
                ],
                [
                    77.00214385986328,
                    43.24670944792118
                ],
                [
                    77.00180053710938,
                    43.24672173659053
                ],
                [
                    76.99977870768024,
                    43.24664936855471
                ],
                [
                    76.99777636386767,
                    43.24643296190397
                ],
                [
                    76.99581280308124,
                    43.24607460227176
                ],
                [
                    76.9939069481502,
                    43.24557774332413
                ],
                [
                    76.99207716459915,
                    43.244947173403965
                ],
                [
                    76.99183702191912,
                    43.24484229515109
                ],
                [
                    76.99115463253143,
                    43.24507745835014
                ],
                [
                    76.9892487932514,
                    43.24557431729578
                ],
                [
                    76.98728524859061,
                    43.245932676926486
                ],
                [
                    76.98528292122268,
                    43.246149083576306
                ],
                [
                    76.98326110839847,
                    43.2462214516118
                ],
                [
                    76.98300188616845,
                    43.24621217310525
                ],
                [
                    76.98179211757765,
                    43.24643296190397
                ],
                [
                    76.98138458300669,
                    43.24647700688317
                ],
                [
                    76.98100914550889,
                    43.24657488314116
                ],
                [
                    76.97904556859656,
                    43.24693324277487
                ],
                [
                    76.97704320833905,
                    43.24714964942654
                ],
                [
                    76.9750213623047,
                    43.24722201746266
                ],
                [
                    76.97467803955081,
                    43.24720972889418
                ],
                [
                    76.9743347167969,
                    43.24722201746266
                ],
                [
                    76.973991394043,
                    43.24720972889418
                ],
                [
                    76.97364807128908,
                    43.24722201746266
                ],
                [
                    76.97330474853517,
                    43.24720972889418
                ],
                [
                    76.97296142578126,
                    43.24722201746266
                ],
                [
                    76.97261810302736,
                    43.24720972889418
                ],
                [
                    76.97227478027345,
                    43.24722201746266
                ],
                [
                    76.97193145751955,
                    43.24720972889418
                ],
                [
                    76.97158813476564,
                    43.24722201746266
                ],
                [
                    76.97124481201173,
                    43.24720972889418
                ],
                [
                    76.97090148925783,
                    43.24722201746266
                ],
                [
                    76.97055816650392,
                    43.24720972889418
                ],
                [
                    76.97021484375001,
                    43.24722201746266
                ],
                [
                    76.96987152099612,
                    43.24720972889418
                ],
                [
                    76.96952819824222,
                    43.24722201746266
                ],
                [
                    76.96918487548831,
                    43.24720972889418
                ],
                [
                    76.9688415527344,
                    43.24722201746266
                ],
                [
                    76.96849822998047,
                    43.24720972889418
                ],
                [
                    76.96815490722656,
                    43.24722201746266
                ],
                [
                    76.96781158447266,
                    43.24720972889418
                ],
                [
                    76.96746826171876,
                    43.24722201746266
                ],
                [
                    76.96712493896486,
                    43.24720972889418
                ],
                [
                    76.96678161621095,
                    43.24722201746266
                ],
                [
                    76.96643829345705,
                    43.24720972889418
                ],
                [
                    76.96609497070314,
                    43.24722201746266
                ],
                [
                    76.96575164794925,
                    43.24720972889418
                ],
                [
                    76.96540832519534,
                    43.24722201746266
                ],
                [
                    76.96506500244143,
                    43.24720972889418
                ],
                [
                    76.96472167968751,
                    43.24722201746266
                ],
                [
                    76.96437835693361,
                    43.24720972889418
                ],
                [
                    76.9640350341797,
                    43.24722201746266
                ],
                [
                    76.9636917114258,
                    43.24720972889418
                ],
                [
                    76.96334838867189,
                    43.24722201746266
                ],
                [
                    76.96300506591798,
                    43.24720972889418
                ],
                [
                    76.96266174316408,
                    43.24722201746266
                ],
                [
                    76.96197509765626,
                    43.24719744032569
                ],
                [
                    76.96128845214845,
                    43.24722201746266
                ],
                [
                    76.96094512939456,
                    43.24720972889418
                ],
                [
                    76.96060180664065,
                    43.24722201746266
                ],
                [
                    76.96025848388673,
                    43.24720972889418
                ],
                [
                    76.95991516113281,
                    43.24722201746266
                ],
                [
                    76.9595718383789,
                    43.24720972889418
                ],
                [
                    76.95922851562501,
                    43.24722201746266
                ],
                [
                    76.95888519287111,
                    43.24720972889418
                ],
                [
                    76.9585418701172,
                    43.24722201746266
                ],
                [
                    76.95819854736328,
                    43.24720972889418
                ],
                [
                    76.95785522460938,
                    43.24722201746266
                ],
                [
                    76.95751190185547,
                    43.24720972889418
                ],
                [
                    76.95716857910156,
                    43.24722201746266
                ],
                [
                    76.95648193359375,
                    43.24719744032569
                ],
                [
                    76.95579528808595,
                    43.24722201746266
                ],
                [
                    76.95545196533205,
                    43.24720972889418
                ],
                [
                    76.95510864257814,
                    43.24722201746266
                ],
                [
                    76.95476531982423,
                    43.24720972889418
                ],
                [
                    76.95442199707033,
                    43.24722201746266
                ],
                [
                    76.95407867431642,
                    43.24720972889418
                ],
                [
                    76.95373535156251,
                    43.24722201746266
                ],
                [
                    76.95339202880861,
                    43.24720972889418
                ],
                [
                    76.9530487060547,
                    43.24722201746266
                ],
                [
                    76.9523620605469,
                    43.24719744032569
                ],
                [
                    76.95167541503909,
                    43.24722201746266
                ],
                [
                    76.95098876953128,
                    43.24719744032569
                ],
                [
                    76.95030212402345,
                    43.24722201746266
                ],
                [
                    76.94995880126955,
                    43.24720972889418
                ],
                [
                    76.94961547851564,
                    43.24722201746266
                ],
                [
                    76.94927215576173,
                    43.24720972889418
                ],
                [
                    76.94892883300783,
                    43.24722201746266
                ],
                [
                    76.94690698697347,
                    43.24714964942654
                ],
                [
                    76.94490462671597,
                    43.24693324277487
                ],
                [
                    76.94294104980365,
                    43.24657488314116
                ],
                [
                    76.941371349826,
                    43.246165663601595
                ],
                [
                    76.93990674160109,
                    43.24643296190397
                ],
                [
                    76.93790439778853,
                    43.24664936855471
                ],
                [
                    76.93720522174611,
                    43.24667439440316
                ],
                [
                    76.93578690160436,
                    43.24693324277487
                ],
                [
                    76.93378454134687,
                    43.24714964942654
                ],
                [
                    76.93176269531251,
                    43.24722201746266
                ],
                [
                    76.93141937255861,
                    43.24720972889418
                ],
                [
                    76.9310760498047,
                    43.24722201746266
                ],
                [
                    76.9307327270508,
                    43.24720972889418
                ],
                [
                    76.93038940429689,
                    43.24722201746266
                ],
                [
                    76.92836755826254,
                    43.24714964942654
                ],
                [
                    76.92636519800504,
                    43.24693324277487
                ],
                [
                    76.92440162109271,
                    43.24657488314116
                ],
                [
                    76.9224957505104,
                    43.246078024191505
                ],
                [
                    76.92066595193371,
                    43.24544745426889
                ],
                [
                    76.91892985643065,
                    43.24468925015124
                ],
                [
                    76.91730419031458,
                    43.24381071837297
                ],
                [
                    76.91580461380089,
                    43.242820324681716
                ],
                [
                    76.91444557003061,
                    43.24172761231593
                ],
                [
                    76.91324014592186,
                    43.240543109898084
                ],
                [
                    76.9121999461904,
                    43.239278229838185
                ],
                [
                    76.911334981751,
                    43.237945158233615
                ],
                [
                    76.91065357356788,
                    43.236556737333224
                ],
                [
                    76.91016227287018,
                    43.23512634170416
                ],
                [
                    76.90986579848719,
                    43.23366774930013
                ],
                [
                    76.90976699189065,
                    43.232195008677834
                ]
            ]
        ]
    ]
}`




const PaintPolygon = L.Control.extend({
    options: {
        position: 'topright',
        radius: 30,
        minRadius: 10,
        maxRadius: 50,
        layerOptions: {
        },
        drawOptions: {
            weight: 1
        },
        eraseOptions: {
            color: '#ff324a',
            weight: 1
        },
        menu: {
            drawErase: true,
            size: true,
            eraseAll: true
        },
    },

    _latlng: [0, 0],
    _metersPerPixel: {},

    onAdd: function(map) {
        this._map = map;
        this.setRadius(this.options.radius);

        if (this.options.menu === false) {
            return L.DomUtil.create('div');
        }

        this._container = L.DomUtil.create('div', 'leaflet-control-paintpolygon leaflet-bar leaflet-control');
        this._createMenu();

        return this._container;
    },

    onRemove: function() {
        this._map.off('mousemove', this._onMouseMove, this);
    },

    setRadius: function(radius) {
        if (radius !== undefined) {
            if (radius < this.options.minRadius) {
                this._radius = this.options.minRadius;
            } else if (radius > this.options.maxRadius) {
                this._radius = this.options.maxRadius;
            } else {
                this._radius = radius;
            }
        }
        if (this._circle) {
            this._circle.setRadius(this._radius);
        }
    },
    startDraw: function() {
        this.stop();
        this._action = 'draw';
        this._addMouseListener();
        this._circle = L.circleMarker(this._latlng, this.options.drawOptions).setRadius(this._radius).addTo(this._map);
        console.log(this._circle);
    },
    startErase: function() {
        this.stop();
        this._action = 'erase';
        this._addMouseListener();
        this._circle = L.circleMarker(this._latlng, this.options.eraseOptions).setRadius(this._radius).addTo(this._map);
    },
    stop: function() {
        this._action = null;
        if (this._circle) {
            this._circle.remove();
        }
        this._removeMouseListener();
    },
    getLayer: function() {
        return this._layer;
    },
    setData: function(data) {
        this._data = data;
        if (this._layer !== undefined) {
            this._layer.remove();
        }
        console.group('setData')
        console.log(this._data, this.options)
        this._layer = L.geoJSON(this._data, this.options.layerOptions).addTo(this._map);
        console.groupEnd()
    },
    getData: function() {
        return this._data;
    },
    eraseAll: function() {
        this.setData();
    },

    /////////////////////////
    // Menu creation and click callback
    _createMenu: function() {
        if (this.options.menu.drawErase !== false) {
            this._iconDraw = L.DomUtil.create('a', 'leaflet-control-paintpolygon-icon leaflet-control-paintpolygon-icon-brush', this._container);
            this._iconErase = L.DomUtil.create('a', 'leaflet-control-paintpolygon-icon leaflet-control-paintpolygon-icon-eraser', this._container);
            L.DomEvent.on(this._iconDraw, 'click mousedown', this._clickDraw, this);
            L.DomEvent.on(this._iconErase, 'click mousedown', this._clickErase, this);
        }

        if (this.options.menu.size !== false) {
            this._iconSize = L.DomUtil.create('a', 'leaflet-control-paintpolygon-icon leaflet-control-paintpolygon-icon-size', this._container);

            this._menu = L.DomUtil.create('div', 'leaflet-bar leaflet-control-paintpolygon-menu', this._container);
            L.DomEvent.disableClickPropagation(this._menu);

            var menuContent = L.DomUtil.create('div', 'leaflet-control-paintpolygon-menu-content', this._menu);
            var cursor = L.DomUtil.create('input', '', menuContent);
            cursor.type = "range";
            cursor.value = this._radius;
            cursor.min = this.options.minRadius;
            cursor.max = this.options.maxRadius;

            L.DomEvent.on(cursor, 'input change', this._cursorMove, this);
            L.DomEvent.on(this._iconSize, 'click mousedown', this._clickSize, this);
        }

        if (this.options.menu.eraseAll !== false) {
            this._iconEraseAll = L.DomUtil.create('a', 'leaflet-control-paintpolygon-icon leaflet-control-paintpolygon-icon-trash', this._container);
            L.DomEvent.on(this._iconEraseAll, 'click mousedown', this._clickEraseAll, this);
        }
    },

    _clickDraw: function(evt) {
        if (evt.type == 'mousedown') {
            L.DomEvent.stop(evt);
            return;
        }
        this._resetMenu();
        if (this._action == 'draw') {
            this.stop();
        } else {
            this.startDraw();
            this._activeIconStyle(this._iconDraw);
        }
    },
    _clickErase: function(evt) {
        if (evt.type == 'mousedown') {
            L.DomEvent.stop(evt);
            return;
        }
        this._resetMenu();
        if (this._action == 'erase') {
            this.stop();
        } else {
            this.startErase();
            this._activeIconStyle(this._iconErase);
        }
    },
    _clickSize: function(evt) {
        if (evt.type == 'mousedown') {
            L.DomEvent.stop(evt);
            return;
        }
        if (L.DomUtil.hasClass(this._menu, 'leaflet-control-paintpolygon-menu-open')) {
            this._closeMenu();
        } else {
            this._openMenu();
        }
    },
    _clickEraseAll: function(evt) {
        this.eraseAll();
    },
    _resetMenu: function() {
        L.DomUtil.removeClass(this._iconDraw, "leaflet-control-paintpolygon-icon-active");
        L.DomUtil.removeClass(this._iconErase, "leaflet-control-paintpolygon-icon-active");
    },
    _activeIconStyle: function(icon) {
        L.DomUtil.addClass(icon, "leaflet-control-paintpolygon-icon-active");
    },
    _openMenu: function() {
        L.DomUtil.addClass(this._menu, "leaflet-control-paintpolygon-menu-open");
    },
    _closeMenu: function() {
        L.DomUtil.removeClass(this._menu, "leaflet-control-paintpolygon-menu-open");
    },
    _cursorMove: function(evt) {
        this.setRadius(evt.target.valueAsNumber);
    },
    /////////////////



    ////////////////
    // Map events
    _addMouseListener: function() {
        this._map.on('mousemove', this._onMouseMove, this);
        this._map.on('mousedown', this._onMouseDown, this);
        this._map.on('mouseup', this._onMouseUp, this);
    },
    _removeMouseListener: function() {
        this._map.off('mousemove', this._onMouseMove, this);
        this._map.off('mousedown', this._onMouseDown, this);
        this._map.off('mouseup', this._onMouseUp, this);
    },
    _onMouseDown: function(evt) {
        this._map.dragging.disable();
        this._mousedown = true;
        this._onMouseMove(evt);
    },
    _onMouseUp: function(evt) {
        this._map.dragging.enable();
        this._mousedown = false;

        console.group('debug');
        console.log('map', this._map);
        console.log('circle', this._circle);
        console.log('stack', this._stack);
        console.groupEnd();

    },
    _onMouseMove: function(evt) {
        //console.log('_onMouseMove', evt);
        this._setLatLng(evt.latlng);
        if (this._mousedown === true) {
            this._stackEvt(evt.latlng, this._map.getZoom(), this._radius, this._action);
        }
    },
    ////////////////

    _setLatLng: function(latlng) {
        if (latlng !== undefined) {
            this._latlng = latlng;
        }
        if (this._circle) {
            this._circle.setLatLng(this._latlng);
        }
    },

    _latLngAsGeoJSON: function(latlng) {
        return {
            type: "Point",
            coordinates: [
                latlng.lng,
                latlng.lat
            ]
        };
    },

    _getCircleAsPolygon: function(latlng, zoom, radius) {
        var lat = latlng.lat;

        if (this._metersPerPixel[zoom] === undefined){
            this._metersPerPixel[zoom] = 40075016.686 * Math.abs(Math.cos(lat * Math.PI / 180)) / Math.pow(2, zoom + 8);
        }
        return turf.circle(this._latLngAsGeoJSON(latlng), this._metersPerPixel[zoom] * radius / 1000, {
            //steps: 128
        });
    },

    _draw: function(latlng, zoom, radius) {
        console.log({latlng, zoom, radius});
        if (this._data === undefined || this._data === null) {
            this.setData(this._getCircleAsPolygon(latlng, zoom, radius));
        } else {
            let fc = {
                type: "FeatureCollection",
                features:[this._data, this._getCircleAsPolygon(latlng, zoom, radius)]
            };
            this.setData(turf.union(fc));
        }
    },
    _erase: function(latlng, zoom, radius) {
        if (this._data === undefined || this._data === null) {
            return;
        } else {
            this.setData(turf.difference(this._data, this._getCircleAsPolygon(latlng, zoom, radius)));
        }
    },

    _stackEvt: function(latlng, zoom, radius, action) {
        if (this._stack === undefined){
            this._stack = new Array();
        }

        this._stack.push({latlng: latlng, zoom: zoom, radius: radius, action: action});
        this._processStack();
    },

    _processStack: function() {
        if (this._processingStack === true || this._stack.length == 0){
            return;
        }
        this._processingStack = true;

        var evt = this._stack.shift();
        if (evt.action == "draw"){
            this._draw(evt.latlng, evt.zoom, evt.radius);
        } else if (evt.action == "erase") {
            this._erase(evt.latlng, evt.zoom, evt.radius);
        }

        this._processingStack = false;
        this._processStack();
    }
 
});


L.Control.PaintPolygon = PaintPolygon;
L.control.paintPolygon = options => new L.Control.PaintPolygon(options);



export default PaintPolygon;
